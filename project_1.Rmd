---
title: "How old is mussel?"
output: 
  html_document: 
    highlight: pygments
    theme: flatly
    toc: yes
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```


## Used libraries. Please, check the versions of your libraries
```{r libraries}
#R version 3.6.1 (2019-07-05)
require(dplyr) # version 1.0.0
require(ggplot2) # version 3.3.2
require(stats) #version 3.6.1
require(tibble) #version 3.0.1
require(cowplot) #version 1.1.0
require(GGally) #version 2.0.0
require(psych) #version 1.9.12.31
```


---


# 1. Combining all observations into one table

```{r merging tables}
path <- 'D:/BIOINF/Data_pr1'
merging_tables <- function(path){
  setwd(path)
  temp = list.files(pattern="*.csv") #temporal list with names of files
  merged_table <- do.call(rbind, lapply(temp, function(x) read.csv(x))) #combine all datasets into sigle dataset
  return(merged_table)
}


mussels <- merging_tables(path)

```


---


# 2. Short EDA
### 1.Right data structure and type of variables

Now we check the structure of our dataset. All variables must be numeric, except column 2. We transform 'Rings' and 'Length' from character to numeric. Column 2 transform from character to factor and rename it, because long name is very uncomfortable. But now we lose information about meaning levels '1', '2', '3'. Moreover, we have levels 'male', 'one' and 'three'. So we need rename levels to 'male', 'female', 'uvenil'. Now our dataset is more readable. 


```{r correct data }
str(mussels) #look at the data structure
mussels$Rings <- as.factor(mussels$Rings) #transform character to factor
mussels$Length <- as.factor(mussels$Length) #transform character to factor
str(mussels) #look at the data structure

levels(mussels$Rings)
levels(mussels$Rings)[29] <- '9'
levels(mussels$Length)

mussels$Rings <- as.numeric(as.character(mussels$Rings)) #transform character to numeric
mussels$Length <- as.numeric(as.character(mussels$Length)) #transform character to numeric



names(mussels)[2] <- 'Sex'
mussels$Sex <- as.factor(mussels$Sex)
levels(mussels$Sex) #"1"     "2"     "3"     "male"  "one"   "three"
levels(mussels$Sex) <- c('male', 'female', 'uvenil', 'male', 'male', 'uvenil')
str(mussels) # OK!

#all numbers must be positive
apply(mussels[-2], 2, function(x) sum(x < 0, na.rm = T))
# Ring must be integer
sum(mussels$Rings %% 1 != 0, na.rm = T) #OK!


```


### 2. NA

Next we need to check NA. We can replace it to zero or mean, but we have just 22 string with NA, this is 0.53% of all observations. So let's remove these strings, it will be more justified. Just in case, we need to check the number of sex group (if we have very small group, we can remove a lot of significant observation together togwther with NA). Our groups are approximately equal in number, so we can create a new dataset whithout NA. 


```{r NA}
#NA
apply(mussels, 2, function(x) sum(is.na(x)))

#number of sex group
num1 <- c(nrow(subset(mussels, Sex == 'male')), nrow(subset(mussels, Sex == 'female')), nrow(subset(mussels, Sex == 'uvenil')))
names(num1) <- c('male', 'female', 'uvenil')
print(num1)

mussels_na.rm <- na.omit(mussels)

#number of sex group in dataset without NA
num2 <- c(nrow(subset(mussels_na.rm, Sex == 'male')), nrow(subset(mussels_na.rm, Sex == 'female')), nrow(subset(mussels_na.rm, Sex == 'uvenil')))
names(num2) <- c('male', 'female', 'uvenil')
print(num2)
```

### 3. Outliers

Let's see outliers on boxplot. We make boxplot for each sex group to try to see difference between groups at the same time. 

```{r outliers}
# visualization
p_Rings <- ggplot(data = mussels_na.rm, aes(y = Rings, fill = Sex)) + geom_boxplot() + theme(legend.position="none")
p_Length <- ggplot(data = mussels_na.rm, aes(y = Length, fill = Sex)) + geom_boxplot() + theme(legend.position="none")
p_Diameter <- ggplot(data = mussels_na.rm, aes(y = Diameter, fill = Sex)) + geom_boxplot() + theme(legend.position="none")
p_Hight <- ggplot(data = mussels_na.rm, aes(y = Height, fill = Sex)) + geom_boxplot() + theme(legend.position="none")
p_Weight <- ggplot(data = mussels_na.rm, aes(y = Whole_weight, fill = Sex)) + geom_boxplot() + theme(legend.position="none")
p_ShWeight <- ggplot(data = mussels_na.rm, aes(y = Shucked_weight, fill = Sex)) + geom_boxplot() + theme(legend.position="none")
p_VisWeight <- ggplot(data = mussels_na.rm, aes(y = Viscera_weight, fill = Sex)) + geom_boxplot() + theme(legend.position="none")
p_ShellWeight <- ggplot(data = mussels_na.rm, aes(y = Shell_weight, fill = Sex)) + geom_boxplot() + theme(legend.position="none")

legend <- get_legend(p_Rings + theme(legend.position = 'bottom'))


plot_grid(p_Rings, p_Length, p_Diameter, p_Hight, p_ShWeight, p_VisWeight, p_ShellWeight, legend) 
```


We will remove outliers in every sex group, except outliers in Rings, because these outliers corresponding to very old or very young animals, and it will be better to save these observations.



```{r removing outliers}
replace_outliers_NA <- function(x){
  Q1 =  quantile(x, 0.25)
  Q3 = quantile(x, 0.75)
  IQR = Q3 - Q1
  x[x < Q1 - 1.5 * IQR | x > Q3 + 1.5 * IQR] <- NA
  return(x)
}

mussels_gr <- group_by(mussels_na.rm, Sex)
mussels_correct <- as_data_frame(apply(mussels_gr[-c(1,2)], 2, replace_outliers_NA))
mussels_correct <- cbind(mussels_gr[1], mussels_correct)
mussels_correct <- add_column(mussels_correct, mussels_gr[2], .after = 1)

mussels_correct <- na.omit(mussels_correct) #dataset without outliers

# check boxplots
p_Rings <- ggplot(data = mussels_correct, aes(y = Rings, fill = Sex)) + geom_boxplot() + theme(legend.position="none")
p_Length <- ggplot(data = mussels_correct, aes(y = Length, fill = Sex)) + geom_boxplot() + theme(legend.position="none")
p_Diameter <- ggplot(data = mussels_correct, aes(y = Diameter, fill = Sex)) + geom_boxplot() + theme(legend.position="none")
p_Hight <- ggplot(data = mussels_correct, aes(y = Height, fill = Sex)) + geom_boxplot() + theme(legend.position="none")
p_Weight <- ggplot(data = mussels_correct, aes(y = Whole_weight, fill = Sex)) + geom_boxplot() + theme(legend.position="none")
p_ShWeight <- ggplot(data = mussels_correct, aes(y = Shucked_weight, fill = Sex)) + geom_boxplot() + theme(legend.position="none")
p_VisWeight <- ggplot(data = mussels_correct, aes(y = Viscera_weight, fill = Sex)) + geom_boxplot() + theme(legend.position="none")
p_ShellWeight <- ggplot(data = mussels_correct, aes(y = Shell_weight, fill = Sex)) + geom_boxplot() + theme(legend.position="none")

legend <- get_legend(p_Rings + theme(legend.position = 'bottom'))

plot_grid(p_Rings, p_Length, p_Diameter, p_Hight, p_ShWeight, p_VisWeight, p_ShellWeight, legend)

```


It not very helps us, but it got better. 



### 4. Correlation

Now we will see on correlations in our data. We have dependent variables: "Whole_weight", "Shucked_weight", "Viscera_weight" and "Shell_weight". Let's keep just "Whole_weight". 

```{r}
ggpairs(mussels_correct, columns = c(6:9),
        ggplot2::aes(colour = Sex, alpha = 0.3), progress = FALSE, 
        lower = list(combo = wrap(ggally_facethist, binwidth = 0.5))) +
  ggtitle('The corralation and distribution matrix')
```



Now we get the correlation plot for "Rings", "Length", Diameter", "Hight" and "Whole_weight".
We see (on this and previously plots) that all of our variables are not normally distributed. We can see linear dependence "Diameter" - "Length", "Diameter" - "Hight" and "Length" - "Hight", but may be some of these variables are dependent. 

We also see dependence between linear dimensions and "Whole_weight". And this dependence is not linear at low values. 


```{r correlation}
ggpairs(mussels_correct, columns = c(1, 3, 4, 5, 6),
        ggplot2::aes(colour = Sex, alpha = 0.3), progress = FALSE, 
        lower = list(combo = wrap(ggally_facethist, binwidth = 0.5))) +
  ggtitle('The corralation and distribution matrix for all independent numeric variables')
```


Now we can put forward some hypotheses:
*1. Non-linear correlation (probably, cubic) between Length, Hight,* *Diameter and Whole_weight *
*2. Linear correlation between Length and Diameter, Length and Hight,* *Diameter and Hight. It can means that all mussels have approximately* *the same proportions, regardless of their size.*


---


# 3. Mean and SD of Length for different sex mussels
```{r mean_sd Length}
mussels_correct %>% group_by(Sex) %>% summarise(mean = mean(Length), SD = sd(Length))
```


---


# 4. What percentage of mussels has Height less than 0.165?

```{r Height <= 0.165}
sum(mussels_correct$Height <= 0.165) / nrow(mussels_correct) * 100
```


---


# 5. What is the value of the Length variable, which is greater than 92% of all observations?

```{r Length }
sort(mussels_correct$Length, decreasing = FALSE)[ceiling(nrow(mussels_correct) * 0.92)]
```


---


# 6. Standartization of Length

```{r Lenght_z_scores}
mussels_correct$Lenght_z_scores <- (mussels_correct$Length - mean(mussels_correct$Length))/sd(mussels_correct$Length)

str(mussels_correct)

```


---


# 7. Ð¡omparison of the diameter of a mussels with the number of rings 5 and 15

First, let's see if there are visible differences in diameter in mussels with 5 and 15 rings by sex group. 

```{r 5 VS 15}
df <- filter(mussels_correct, Rings == c(5, 15))

ggplot(df, aes(x = as.factor(Rings), y = Diameter, fill = as.factor(Rings))) +
  geom_boxplot() +
  facet_wrap(. ~ Sex) +
  theme_bw() + xlab('Rings') + labs(fill = 'Rings') + 
  ggtitle('Boxplots for diameter of 15-ring and 5-ring mussels, grouping by their sex')

```



There are practically no differences between sex groups, so we can compare the diameter of mussels in general. Firstly, we look at the boxplot and the distribution of this variable.


```{r }
ggplot(df, aes(x = as.factor(Rings), y = Diameter, fill = as.factor(Rings))) +
  geom_boxplot() +
  theme_bw() + xlab('Rings') + labs(fill = 'Rings') +
  ggtitle('Boxplots for diameter of 15-ring and 5-ring mussels (without grouping)')

ggplot(df, aes(Diameter, fill = as.factor(Rings))) +
  geom_density(alpha = 0.5) +
  theme_bw() + xlab('Rings') + labs(fill = 'Rings') + ylab('Diameter') +
  ggtitle('Diameters distribution of 5-ring and 15-ring mussels')

```

We see that the distribution of the quantity is not normal, that's why we need to use Wilcoxon signed-rank test to test the following assumption: *the diameter of the 15-ring mussels is greater than the diameter of the 5-ring mussels.*

```{r t.test}
wilcox.test(Diameter ~ Rings, data = df)

```


Since p-value is less than 0.05, we have reason to reject the null hypothesis that there is no difference in Diameter between groups. We can argue that difference in Diameter in 15-ring mussels and 5-ring mussels is significant. 


---


# 8. Diameter and Whole Weght

We want to check any dependence between Diameter and Whole Weight of mussels. Let's look on the scatterplot again.


```{r}
ggplot(mussels_correct, aes(x = Diameter, y = Whole_weight))+
  geom_point() + geom_smooth() + theme_bw() +
  ggtitle('Dependence of Whole weight on Diameter')
```



There is a correlation between variales, but it is not linear. And this is understandable: mass is directly proportional to volume, and volume is proportional to the third power of linear measurements. So, we can assume that the dependence between weight and diameter is cubic. 


Let's try to calculate the volume of mussels and look at the corralation between Volume and Whole Weight.  
We will consider the mussel as an ellipsoid, and calculate its volume by the formula *V = 4abc x pi / 3*

```{r}
mussels_correct$Volume <- 4 * 3.14 * (mussels_correct$Length) * mussels_correct$Diameter * (mussels_correct$Height) / 24

ggplot(mussels_correct, aes(x = Volume, y = Whole_weight))+
  geom_point() + geom_smooth() + theme_bw() +
  ggtitle('Dependence of Whole weight on Volume')
```



Now we see the linear correlation. Let's calculate the correlation coefficient. We need to check the distribution of variables.

```{r}
p_Volume <- ggplot(mussels_correct, aes(x = Volume)) +geom_density() + theme_bw()
p_Weight <- ggplot(mussels_correct, aes(x = Whole_weight)) + geom_density() + theme_bw()

plot_grid(p_Volume, p_Weight)
```


Distribution is not normal, so we can use Spearman method to calaulate correlation coefficient.

```{r}
cor.test(mussels_correct$Volume, mussels_correct$Whole_weight, method = 'spearman')

```


We have got correlation coefficient 0.97 and p-value << 0.05. 









